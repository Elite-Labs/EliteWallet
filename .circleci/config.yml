# Couldn't automatically generate a config from your source code.
# This is a generic template to serve as a base for your custom config
# See: https://circleci.com/docs/configuration-reference
# Stacks detected: cicd:github-actions:.github/workflows
version: 2.1
jobs:
  build:
    macos:
      xcode: 14.3.1
    steps:
      - checkout
      - run: |
          # create variables
          CERTIFICATE_PATH=~/build_certificate.p12
          PP_PATH=~/build_pp.mobileprovision
          KEYCHAIN_PATH=~/Library/Keychains/$MATCH_KEYCHAIN_NAME-db

          # import certificate and provisioning profile from secrets
          echo -n "$Certificates" | base64 --decode -o $CERTIFICATE_PATH
          echo -n "$App_Store_Profile" | base64 --decode -o $PP_PATH

          # create temporary keychain
          security create-keychain -p "$MATCH_KEYCHAIN_PASSWORD" $KEYCHAIN_PATH
          security set-keychain-settings -lut 21600 $KEYCHAIN_PATH
          security unlock-keychain -p "$MATCH_KEYCHAIN_PASSWORD" $KEYCHAIN_PATH

          # import certificate to keychain
          security import $CERTIFICATE_PATH -P "$CERTIFICATE_PASSWORD" -A -t cert -f pkcs12 -k $KEYCHAIN_PATH
          security set-key-partition-list -S apple-tool:,apple: -k "$MATCH_KEYCHAIN_PASSWORD" $KEYCHAIN_PATH
          security list-keychain -d user -s $KEYCHAIN_PATH

          # apply provisioning profile
          mkdir -p ~/Library/MobileDevice/Provisioning\ Profiles
          cp $PP_PATH ~/Library/MobileDevice/Provisioning\ Profiles/App_Store.mobileprovision
          cp $CERTIFICATE_PATH ios/Certificates.p12
      - restore_cache:
          name: Restore Deps
          keys:
            - deps-cache
      - run:
          name: Build Deps
          command: ./scripts/build_deps.sh ios;
      - save_cache:
          name: Cache Deps
          key: deps-cache
          paths:
            - ew_shared_external/ios/External/sources/elite_wallet_data
      - run:
          name: Build
          command: ./scripts/build.sh --packages-only ios; .flutter/bin/flutter build ios --debug
      - run: |
          mkdir Payload
          cp -R build/ios/iphoneos/Runner.app Payload/
          cp ~/build_pp.mobileprovision "Payload/Runner.app/embedded.mobileprovision"
          codesign -f -s "Apple Distribution: OPCDT HOLDING LIMITED (L7NMAVCM28)" "Payload/Runner.app"
          ls Payload/Runner.app
          zip -qr app.ipa Payload/
      - store_artifacts:
          path: app.ipa

workflows:
  build-ios:
    jobs:
      - build
